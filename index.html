<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoTrack WebView</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Map Container Height adjustment */
        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
        }

        /* MapLibre specific marker styling */
        .user-marker {
            background-color: #2563eb;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* Hide MapLibre default controls for a cleaner app look */
        .maplibregl-ctrl {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden flex flex-col font-sans select-none">

    <!-- Main Content Area -->
    <main class="flex-grow relative overflow-hidden bg-gray-100">
        
        <!-- VIEW: MAP (Default) -->
        <div id="view-map" class="absolute inset-0 flex flex-col">
            <!-- Map Layer -->
            <div id="map" class="bg-gray-200"></div>

            <!-- Zoom Controls (Bottom Right) -->
            <div class="absolute bottom-24 right-6 flex flex-col space-y-3 z-[400] drop-shadow-lg">
                <button onclick="zoomIn()" class="bg-white text-gray-700 p-2.5 rounded-full shadow-lg hover:bg-gray-100 transition-colors active:scale-95 ring-1 ring-gray-300 w-12 h-12 flex items-center justify-center">
                    <i class="ph ph-plus text-2xl"></i>
                </button>
                <button onclick="zoomOut()" class="bg-white text-gray-700 p-2.5 rounded-full shadow-lg hover:bg-gray-100 transition-colors active:scale-95 ring-1 ring-gray-300 w-12 h-12 flex items-center justify-center">
                    <i class="ph ph-minus text-2xl"></i>
                </button>
            </div>

            <!-- Floating Action Button (Start/Stop) -->
            <div class="absolute bottom-4 left-0 right-0 flex justify-center z-[400] px-6">
                <button id="btn-toggle-track" onclick="toggleTracking()" class="shadow-2xl bg-blue-600 hover:bg-blue-700 text-white w-full max-w-md h-16 rounded-2xl flex items-center justify-center gap-3 font-bold text-xl active:scale-95 transition-all duration-200 ring-4 ring-white/30 backdrop-blur-sm">
                    <i id="btn-icon" class="ph-fill ph-play text-2xl"></i>
                    <span id="btn-text">Start Tracking</span>
                </button>
            </div>
        </div>

    </main>

    <!-- MapLibre Worker URL Fix: MUST be set before the library is loaded -->
    <script>
        // Explicitly set the worker URL to prevent SecurityErrors when running in restricted environments.
        window.maplibregl = window.maplibregl || {};
        window.maplibregl.workerUrl = 'https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl-worker.js';
    </script>

    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>

    <script>
        // --- 1. Map Initialization ---

        // Default Location (New York Central Park)
        const DEFAULT_LNG = -73.968285;
        const DEFAULT_LAT = 40.785091;
        const startLngLat = {DEFAULT_LNG, DEFAULT_LAT};
        // Initialize MapLibre Map
        const map = new maplibregl.Map({
            container: 'map',
            base: '', // <-- FIX: Explicitly set the base URL to prevent SecurityError
            style: {
                version: 8,
                sources: {
                    'carto-tiles': {
                        type: 'raster',
                        tiles: [
                            'https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',
                            'https://b.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png',
                            'https://c.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: 'Â© CARTO'
                    }
                },
                layers: [
                    {
                        id: 'simple-tiles',
                        type: 'raster',
                        source: 'carto-tiles',
                        minzoom: 0,
                        maxzoom: 22
                    }
                ]
            },
            center: startLngLat,
            zoom: 14,
            attributionControl: false // Hide small text for clean app look
        });

        // 1.1 Custom User Marker Setup (Replicating the original blue circle look)
        const el = document.createElement('div');
        el.className = 'user-marker';

        const userMarker = new maplibregl.Marker({ element: el })
            .setLngLat([DEFAULT_LNG, DEFAULT_LAT])
            .addTo(map);

        // 1.2 Zoom Controls
        function zoomIn() {
            // Smoothly zoom in by one level
            map.zoomIn({ duration: 300 }); 
        }

        function zoomOut() {
            // Smoothly zoom out by one level
            map.zoomOut({ duration: 300 }); 
        }

        // --- 2. Interaction Logic ---

        // Bridge to Android (Native)
        function sendToAndroid(action, data) {
            console.log(`Sending to Android -> Action: ${action}, Data: ${data}`);
            
            // Check if running in actual Android WebView with interface 'Android'
            if (typeof Android !== 'undefined' && Android.handleAction) {
                Android.handleAction(action, JSON.stringify(data || {}));
            }
        }

        // --- 3. Tracking Simulation Logic ---
        let isTracking = false;
        let trackingInterval;
        let seconds = 0;

        function toggleTracking() {
            const btn = document.getElementById('btn-toggle-track');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');

            if (!isTracking) {
                // START
                isTracking = true;
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
                btnText.innerText = "Stop Tracking";
                btnIcon.classList.remove('ph-play');
                btnIcon.classList.add('ph-stop');
                
                sendToAndroid('startTracking');
                startSimulation();
            } else {
                // STOP
                isTracking = false;
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btnText.innerText = "Start Tracking";
                btnIcon.classList.remove('ph-stop');
                btnIcon.classList.add('ph-play');

                sendToAndroid('stopTracking');
                stopSimulation();
            }
        }

        // Mock simulation variables
        let lat = DEFAULT_LAT;
        let lng = DEFAULT_LNG;

        function startSimulation() {
            clearInterval(trackingInterval);
            trackingInterval = setInterval(() => {
                seconds++;
                
                // Simulate movement (random small changes)
                lat += (Math.random() - 0.5) * 0.0002;
                lng += (Math.random() - 0.5) * 0.0002;
                const newLngLat = [lng, lat];

                // Update MapLibre Marker position
                userMarker.setLngLat(newLngLat);
                
                // Center map on new position with a smooth animation
                map.panTo(newLngLat, { duration: 1000 });

            }, 1000);
        }

        function stopSimulation() {
            clearInterval(trackingInterval);
        }
    </script>
</body>
</html>
