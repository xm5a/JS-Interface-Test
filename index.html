<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>GeoTrack WebView</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        #map { height: 100%; width: 100%; z-index: 10; }
        .user-marker {
            background-color: #2563eb;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .maplibregl-ctrl { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen overflow-hidden flex flex-col font-sans select-none">

    <main class="flex-grow relative overflow-hidden bg-gray-100">
        
        <div id="view-map" class="absolute inset-0 flex flex-col">
            <div id="map" class="bg-gray-200"></div>

            <div class="absolute bottom-24 right-6 flex flex-col space-y-3 z-[400] drop-shadow-lg">
                <button onclick="zoomIn()" class="bg-white text-gray-700 p-2.5 rounded-full shadow-lg active:scale-95 ring-1 ring-gray-300 w-12 h-12 flex items-center justify-center">
                    <i class="ph ph-plus text-2xl"></i>
                </button>
                <button onclick="zoomOut()" class="bg-white text-gray-700 p-2.5 rounded-full shadow-lg active:scale-95 ring-1 ring-gray-300 w-12 h-12 flex items-center justify-center">
                    <i class="ph ph-minus text-2xl"></i>
                </button>
            </div>

            <div class="absolute bottom-4 left-0 right-0 flex justify-center z-[400] px-6">
                <button id="btn-toggle-track" onclick="toggleTracking()" class="shadow-2xl bg-blue-600 text-white w-full max-w-md h-16 rounded-2xl flex items-center justify-center gap-3 font-bold text-xl active:scale-95 transition-all duration-200 ring-4 ring-white/30">
                    <i id="btn-icon" class="ph-fill ph-play text-2xl"></i>
                    <span id="btn-text">Start Tracking</span>
                </button>
            </div>

            <div id="geofence-status" class="absolute top-4 left-4 bg-white px-4 py-2 rounded-lg shadow-lg z-[400] font-semibold">
                <span class="text-gray-500">Waiting for GPS...</span>
            </div>
        </div>
    </main>

    <script src="https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js"></script>

    <script>
        // --- 1. Global Variables & Initialization ---
        const geofenceCenter = [72.8777, 19.0760]; // Thane
        const geofenceRadius = 2000; // meters
        
        let isTracking = false;
        let watchId = null;
        let wasInside = false;
        let geostat = "Unknown";
        let CityName = "Searching..."; // Changed to 'let' to allow updates

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'carto-tiles': {
                        type: 'raster',
                        tiles: ['https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '© CARTO'
                    }
                },
                layers: [{ id: 'simple-tiles', type: 'raster', source: 'carto-tiles' }]
            },
            center: geofenceCenter,
            zoom: 13,
            attributionControl: false
        });

        const el = document.createElement('div');
        el.className = 'user-marker';
        const userMarker = new maplibregl.Marker({ element: el }).setLngLat(geofenceCenter).addTo(map);

        map.on('load', () => {
            map.addSource('geofence', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: geofenceCenter },
                    properties: { name: "Thane Geofence" }
                }
            });

            map.addLayer({
                id: 'geofence-fill',
                type: 'circle',
                source: 'geofence',
                paint: {
                    'circle-radius': {
                        stops: [[0, 0], [20, metersToPixelsAtMaxZoom(geofenceRadius, geofenceCenter[1])]],
                        base: 2
                    },
                    'circle-color': '#3b82f6',
                    'circle-opacity': 0.2
                }
            });
        });

        // --- 2. Core Functions ---

        /**
         * Reverse Geocoding: Gets city name from coordinates
         */
        async function getCityName(lng, lat) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                // Return city, town, village or suburb
                return data.address.city || data.address.town || data.address.village || data.address.suburb || "Unknown Area";
            } catch (e) {
                console.error("Geocoding failed", e);
                return "Unknown";
            }
        }

        function checkGeofence(lat, lng) {
            const distance = getDistance(geofenceCenter[1], geofenceCenter[0], lat, lng);
            const isInside = distance <= geofenceRadius;
            const statusEl = document.getElementById('geofence-status');

            if (isInside) {
                geostat = wasInside ? "Inside" : "Entered";
                statusEl.innerHTML = '<span class="text-green-600">✓ Inside Geofence</span>';
            } else {
                geostat = wasInside ? "Exited" : "Outside";
                statusEl.innerHTML = '<span class="text-red-600">✗ Outside Geofence</span>';
            }

            if (isInside !== wasInside && window.TouristAppInterface) {
                window.TouristAppInterface.setGeofenceStatus(`Geofence ${isInside ? 'Entered' : 'Exited'}`);
            }
            wasInside = isInside;
        }

        function toggleTracking() {
            const btn = document.getElementById('btn-toggle-track');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');

            if (!isTracking) {
                isTracking = true;
                btn.classList.replace('bg-blue-600', 'bg-red-500');
                btnText.innerText = "Stop Tracking";
                btnIcon.classList.replace('ph-play', 'ph-stop');
                startWatchingPosition();
                sendToAndroid('startTracking', {});
            } else {
                isTracking = false;
                btn.classList.replace('bg-red-500', 'bg-blue-600');
                btnText.innerText = "Start Tracking";
                btnIcon.classList.replace('ph-stop', 'ph-play');
                stopWatchingPosition();
                sendToAndroid('stopTracking', {});
            }
        }

        function startWatchingPosition() {
            if (!navigator.geolocation) return alert("Geolocation not supported");

            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude: lat, longitude: lng, accuracy } = position.coords;
                    
                    // Update UI
                    userMarker.setLngLat([lng, lat]);
                    map.panTo([lng, lat], { duration: 1000 });
                    
                    // Logic checks
                    checkGeofence(lat, lng);
                    CityName = await getCityName(lng, lat); // Await the async fetch

                    // Native Bridge
                    sendToAndroid('locationUpdate', { 
                        lat, lng, accuracy, 
                        timestamp: new Date().toISOString(),
                        Hi: geostat,
                        City: CityName
                    });
                },
                (err) => console.error(err),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function stopWatchingPosition() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }

        // --- 3. Utilities & Bridge ---

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const p1 = lat1 * Math.PI / 180;
            const p2 = lat2 * Math.PI / 180;
            const dp = (lat2 - lat1) * Math.PI / 180;
            const dl = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dp/2)**2 + Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function metersToPixelsAtMaxZoom(meters, latitude) {
            return meters / 0.075 / Math.cos(latitude * Math.PI / 180);
        }

        function zoomIn() { map.zoomIn(); }
        function zoomOut() { map.zoomOut(); }

        function sendToAndroid(action, data) {
            if (window.TouristAppInterface && window.TouristAppInterface.handleAction) {
                window.TouristAppInterface.handleAction(action, JSON.stringify(data));
            } else {
                console.log(`Web Mode [${action}]:`, data);
            }
        }
    </script>
</body>
</html>
